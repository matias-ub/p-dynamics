<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Parejas - Daily Question Game{% endblock %}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’‘</text></svg>">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- HTMX for dynamic interactions -->
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% block extra_head %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">ðŸ’‘ Parejas</a>
            {% block nav_items %}{% endblock %}
        </div>
    </nav>

    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer mt-auto py-3">
        <div class="container text-center">
            <span class="text-muted">Parejas - ConÃ©ctense con una pregunta diaria</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Initialize Supabase client (only once, globally)
    if (!window.appSupabase) {
        window.appSupabase = window.supabase.createClient(
            'https://ghhupdmdqfdllalndmze.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoaHVwZG1kcWZkbGxhbG5kbXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NTQ3NzQsImV4cCI6MjA4NjQzMDc3NH0.jdqZecy_Hg6wbHxpUkZNFSC1uBYN9rFhKP3DXTImshk'
        );
        
        // Listen for auth state changes (auto-refresh handled by Supabase)
        window.appSupabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_OUT') {
                console.log('User signed out');
            }
        });
    }

    // Global auth helper - ensures user has a session
    window.ensureSession = async function() {
        const { data: { session }, error } = await window.appSupabase.auth.getSession();
        
        if (!session) {
            // Create anonymous user
            const { data, error: signInError } = await window.appSupabase.auth.signInAnonymously();
            if (signInError) {
                console.error('Auth error:', signInError);
                return null;
            }
            return data.session;
        }
        
        return session;
    };

    // Get current access token for API calls
    window.getAccessToken = async function() {
        const session = await window.ensureSession();
        return session?.access_token;
    };

    // Attach auth token to all HTMX requests
    document.addEventListener('htmx:configRequest', async (event) => {
        const token = await window.getAccessToken();
        if (token) {
            event.detail.headers['Authorization'] = `Bearer ${token}`;
        }
    });
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
