{% extends "base.html" %}

{% block title %}Pregunta del D√≠a - Parejas{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8">
        <div class="card shadow" id="questionCard">
            <div class="card-body p-5">
                <h3 class="text-center mb-4">Pregunta del D√≠a</h3>
                <p class="lead text-center mb-5">{{ question.text }}</p>
                
                <form id="answerForm">
                    <!-- Your Answer -->
                    <div class="mb-5">
                        <h5 class="mb-3">1Ô∏è‚É£ ¬øQu√© har√≠as t√∫?</h5>
                        <p class="text-muted mb-3">Tu respuesta personal</p>
                        {% for option in question.options %}
                        <div class="form-check mb-3 p-3 border rounded hover-option">
                            <input 
                                class="form-check-input" 
                                type="radio" 
                                name="self_option" 
                                id="self_{{ option.id }}" 
                                value="{{ option.id }}"
                                required>
                            <label class="form-check-label w-100" for="self_{{ option.id }}">
                                {{ option.text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Partner Prediction -->
                    <div class="mb-5">
                        <h5 class="mb-3">2Ô∏è‚É£ ¬øQu√© har√≠a tu pareja?</h5>
                        <p class="text-muted mb-3">Predice qu√© elegir√°</p>
                        {% for option in question.options %}
                        <div class="form-check mb-3 p-3 border rounded hover-option">
                            <input 
                                class="form-check-input" 
                                type="radio" 
                                name="partner_prediction" 
                                id="partner_{{ option.id }}" 
                                value="{{ option.id }}"
                                required>
                            <label class="form-check-label w-100" for="partner_{{ option.id }}">
                                {{ option.text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Enviar Respuestas
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Success message with invite option -->
        <div class="card shadow d-none" id="successCard">
            <div class="card-body p-5 text-center">
                <div class="mb-4">
                    <h3 class="text-success">‚úì ¬°Respuestas enviadas!</h3>
                    <p class="text-muted">Tus respuestas han sido guardadas</p>
                </div>

                <div id="resultsSection" class="d-none text-start mb-4">
                    <div id="waitingAlert" class="alert alert-info d-none">
                        Estado: esperando la respuesta de tu pareja.
                    </div>
                    <div id="responsesContainer"></div>
                    <div id="summaryContainer" class="alert alert-success d-none"></div>
                </div>
                
                <div id="inviteSection" class="d-none">
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">Invita a tu pareja</h5>
                        <p class="mb-3">Comparte este c√≥digo para que tu pareja pueda responder:</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control form-control-lg text-center fw-bold" 
                                   id="inviteToken" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToken()">
                                üìã Copiar
                            </button>
                        </div>
                        <small class="text-muted">O comparte este enlace:</small>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control text-center" 
                                   id="inviteLink" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyLink()">
                                üìã Copiar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-4">
                    <a href="/" class="btn btn-primary btn-lg">Volver al Inicio</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const roomId = '{{ room.id }}';
const roomToken = '{{ room.token if room.token else "" }}';
const appUrl = '{{ app_url|default("") }}';
const baseUrl = appUrl || window.location.origin;
const dailyQuestionId = '{{ question.id }}';

document.getElementById('answerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const selfOption = document.querySelector('input[name="self_option"]:checked');
    const partnerPrediction = document.querySelector('input[name="partner_prediction"]:checked');
    
    if (!selfOption || !partnerPrediction) {
        alert('Por favor responde ambas preguntas');
        return;
    }
    
    try {
        const accessToken = await getAccessToken();
        
        if (!accessToken) {
            alert('Error de autenticaci√≥n. Por favor recarga la p√°gina.');
            return;
        }
        
        const response = await fetch('/api/responses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                room_id: roomId,
                daily_question_id: '{{ question.id }}',
                self_option_id: selfOption.value,
                partner_prediction_option_id: partnerPrediction.value
            })
        });
        
        if (response.ok) {
            // Check how many participants have answered
            const statusResponse = await fetch(`/api/responses/room/${roomId}/status/{{ question.id }}`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            if (statusResponse.ok) {
                const status = await statusResponse.json();
                
                // Hide question form, show success message
                document.getElementById('questionCard').classList.add('d-none');
                document.getElementById('successCard').classList.remove('d-none');
                
                // Show invite section if only 1 participant (this user)
                if (status.answer_count === 1) {
                    const inviteSection = document.getElementById('inviteSection');
                    inviteSection.classList.remove('d-none');
                    
                    // Set token and link
                    document.getElementById('inviteToken').value = roomToken;
                    document.getElementById('inviteLink').value = 
                        `${baseUrl}/join-room?token=${roomToken}`;
                } else {
                    document.getElementById('inviteSection').classList.add('d-none');
                }

                await loadResults(accessToken);
            }
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error al enviar respuestas: ' + error.message);
    }
});

function copyToken() {
    const tokenInput = document.getElementById('inviteToken');
    tokenInput.select();
    document.execCommand('copy');
    alert('C√≥digo copiado al portapapeles');
}

function copyLink() {
    const linkInput = document.getElementById('inviteLink');
    linkInput.select();
    document.execCommand('copy');
    alert('Enlace copiado al portapapeles');
}

function escapeHtml(value) {
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

async function loadResults(accessToken) {
    const resultsSection = document.getElementById('resultsSection');
    const responsesContainer = document.getElementById('responsesContainer');
    const waitingAlert = document.getElementById('waitingAlert');
    const summaryContainer = document.getElementById('summaryContainer');

    resultsSection.classList.remove('d-none');
    responsesContainer.innerHTML = '';
    waitingAlert.classList.add('d-none');
    summaryContainer.classList.add('d-none');

    const responsesResponse = await fetch(
        `/api/responses/room/${roomId}/daily/${dailyQuestionId}`,
        {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        }
    );

    if (!responsesResponse.ok) {
        return;
    }

    const responses = await responsesResponse.json();

    if (!responses || responses.length === 0) {
        return;
    }

    const responseCards = responses.map((resp, index) => {
        const name = resp.profile && resp.profile.name ? resp.profile.name : `Participante ${index + 1}`;
        const selfText = resp.self_option && resp.self_option.text ? resp.self_option.text : '---';
        const predText = resp.prediction_option && resp.prediction_option.text ? resp.prediction_option.text : '---';

        return `
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="fw-bold mb-2">${escapeHtml(name)}</div>
                    <div class="mb-1"><span class="text-muted">Su respuesta:</span> ${escapeHtml(selfText)}</div>
                    <div><span class="text-muted">Su predicci√≥n:</span> ${escapeHtml(predText)}</div>
                </div>
            </div>
        `;
    }).join('');

    responsesContainer.innerHTML = responseCards;

    if (responses.length < 2) {
        waitingAlert.classList.remove('d-none');
        return;
    }

    const [first, second] = responses;
    const firstCorrect = first.partner_prediction_option_id === second.self_option_id;
    const secondCorrect = second.partner_prediction_option_id === first.self_option_id;
    const mutualCount = (firstCorrect ? 1 : 0) + (secondCorrect ? 1 : 0);
    const sharedChoice = first.self_option_id === second.self_option_id;

    summaryContainer.innerHTML = `
        <div class="fw-bold mb-2">Resultados</div>
        <div>üß† Lectura mutua: ${mutualCount}/2</div>
        <div>üéØ Elecci√≥n compartida: ${sharedChoice ? 'S√≠' : 'No'}</div>
    `;
    summaryContainer.classList.remove('d-none');
}
</script>
{% endblock %}
